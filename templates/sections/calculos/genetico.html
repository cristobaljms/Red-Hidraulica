{% load static from staticfiles%} <!DOCTYPE html>
<html lang="en">
  <head>
    <title>Metodo Gradiente</title>
    {% include 'layouts/header.html' %}
  </head>
  <body>
    <div id="container" class="container">
      <b><h1 style="text-align: center;">ALGORITMO GENETICO</h1></b>
      <br>
      <h3>Se estan realizando los calculos, esta operación puede tardar varios minutos. Por favor espere...</h3>
      <div id="pgb"></div>
      <br>
      <h1 id="status"></h1>
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-12">
            <div class="btn-group-sm hidden" id="mini-fab">
              <a
              href="{% url 'proyecto_administrar' project_pk 'i'%}"
                class="btn btn-danger btn-fab"
                data-toggle="tooltip"
                data-placement="left"
                data-original-title="Retornar"
                title=""
                id="mail"
              >
                <img
                  style="width:24px;height:24px"
                  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAANOSURBVFhH5ZhJqI5RGMevMWMyiw0LJENkyoKQqcRGESVjppKSeWMslDKUaWFIVmKHhVgQG8qQzHNZIFNEken3O999u8M33u9738/i/utX73Pu+53z3POec57nORX1QV1gDMyARbAApsFgaA1lV0MYB0fhFfzNwS+4DpuhFySqxuDsPAUH/wmXYSvMhFHgrMkEWAwH4CFEDp+H4RC7hsFtcJDnsBzaQaHqD/vgG/yB49AeYtEqcLY+wTJwJotVJzgCOunyKGk2G8F+cNauQDeISy6Bd/AdpthQjFw/OncCmtgQs7rDI/gB422oi1aCzp2EBjYkJI+oJ+Da7GNDIXJdRDu0qQ0Jqzd8gXvQzIZccgO4W90QXW0ok2aDX2xjsHJoIfji0mCVV5fATeNnzygjhOvhGdTlKBkKzVOPJcl+nJydwcogw5cvrAhWYdoA/sYYHIdc928h46nhAeqW7xCs/FoPOmenLWyIQfPAPicFq5Y82R2sEK2DyLmWNsQkI41RZlewqskd64DbgpVbayEJ5yLdh6upxyqNBgedFazsWgNJOqfOwIfUY5V0zIFHBiuzVkPSzqk94Dg1goS70MaBwUqX2bJ/l6/wsUReQLZ0aws4To10Lto9nkWZpONGF9+5A6dKxNwwWxjdDo7TJliVmg42jg1WZg2Bz/AeBtmQkA7Cb6iRpJim6+CSYGWXM5y0kxfgZeqxSlZfFjjmgPmUpJPO2hs4G6xaugEPUo95ZUqWhJN9wS/pcZamaPcMCFZ+VXcyrpJyE+iDRVaaeoJhZm+wCtMIcL1MDlZpMoMy3N4KVhadA9NvY2K5NRecvfnByiJnxFk0symnWsFr8FIgb4FmUa2TE4NVHh0CZ6+gpWKIcS2YOPawIWFF9Yh3PQXLqw7XoiVA1hohBpmYmiRbqNU56Z0K/tgaJYmbqTlg/4+how3FyCsKsxfrVjuMQ26Iw+BnvQklfyEr/rtghxfBz1+MPOf8J92t9nUM4qplQllpUW3daucmraZohZyX/cALTHNAf+u6juNgz6jOYN3qDncwjyNriNOwG7zM3AGmTGYlBn7fE/NI/6kkLqLS5CDuQKuva2A8jhwR8zlnzKzEwO8s/nfpdNtK6osqKv4BCJ3oDfft8w0AAAAASUVORK5CYII="
                />
              </a>
            </div>
            <div class="btn-group">
              
              <a
                href="javascript:void(0)"
                class="btn btn-success btn-fab"
                id="main"
              >
                <img
                  style="width:24px;height:24px"
                  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEtSURBVGhD7daxSgNREIXhJe8gFhY+hwimUou8u0Ww9SEUIljFOeycZrMhzt25O/fG+eFAAiE7X7dDlmVZdq096roOgE9dtxgijrouMVNEl5gp4kfXFWYOsdN1gzmHYF1gLiFY05i/IliTGCuCNYUpRbAmMBbEi26uUIwV8a1rClOC4G+bweCPv2R8mAXBWTB4ljtmCeKg4/cwzFLEky4U44FgYRhPBFsds5HtZfwTDwRbgsFNuM3UvexD5olgJRjcgpuKupM9jx9PKkUwCwY34Bb3liKYBeOeF4KFYLwRbFXMq6wGgs1h8EzXaiNYVcxaCFYFM4fYymqHZ7hhohDMBYPXgDdZFIJNMbjJ/IpyK3uXRSEYMbgFNxV1I3sYP4aGG3BLlmVZlmX/oGH4BQxKPnDHqXUbAAAAAElFTkSuQmCC"
                />
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>
    <br>
    <form id="my_form" action="export" method="post">
      <input id="my_form_data" type="hidden" name="data" />
  </form>

    {% include 'layouts/scripts.html' %}

    <script type="text/javascript">

      function sortByKey(array, key) {
        return array.sort(function(a, b) {
            var x = a[key]; var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
      }

      var pgb = $('#pgb');
      pgb.ariaProgressbar();
  
      var willstop = 0;
      (function(){
        var poll = function(){
          var task_id = "{{task_id}}";
          $.ajax({
            url:'/poll_state/',
            type: 'POST',
            data: {
                task_id: task_id,
                csrfmiddlewaretoken: "{{csrf_token}}",
            },
            success: function(response) {
              if (response.state == 'PENDING') {
                document.getElementById("status").innerHTML = "Iniciando...";
              }
              else if (response.state == 'PROGRESS') {
                pgb.ariaProgressbar('update', response.result.percent);
                document.getElementById("status").innerHTML = "Población "+response.result.current+" de "+response.result.total+" - "+response.result.percent+"% Completado";
              }
              if(response.state == 'SUCCESS'){
                willstop = 1
                pgb.ariaProgressbar('update', 100);
                
                if(response.result == "NOT_LOAD_GENETIC_DIAMETER"){
                  document.getElementById("status").innerHTML = "Error! No hay diametros cargados";
                }
                else if(response.result == "NO_GENETIC_DATA_LOAD"){
                  document.getElementById("status").innerHTML = "Error! No hay data genetica cargada";
                }
                else if(response.result == "ERROR_MAX_LIMIT_ITERATION"){
                  document.getElementById("status").innerHTML = "Error! se ha superado el limite de iteraciones que es 100, por favor revise que los datos cargados esten correctos";
                }
                else {
                  document.getElementById("status").innerHTML = "¡Listo!";

                  var mejores = []

                  response.result.map(function(row){
                    row[1].map(function(obj){
                      mejores.push(obj)
                    })
                  })
                  mejoresSorted = sortByKey(mejores, "FO")
                  var table_H = $('<table class="table table-bordered"></table>');
                  var theader_H = $('<thead><tr><th>Binario</th><th>FO</th></tr></thead>');
                  var tbody_H = $('<tbody></tbody>');
                  table_H.append(theader_H);
                  table_H.append(tbody_H);
                  $('#container').append(table_H);
                  
                  var contl = mejoresSorted.length
                  if(contl > 10){
                    contl = 10
                  }
                  for(var i = 0; i < contl; i++ ){
                    var row = $('<tr><td><a href="'+mejoresSorted[i].binarios+'">'+mejoresSorted[i].binarios+'</a></td><td>'+mejoresSorted[i].FO+'</td></tr>');
                    tbody_H.append(row)
                  }
   
                  $.ajax({
                    url:'/reporte/pdf/genetico/{{project_pk}}/',
                    type: 'POST',
                    data: {
                      data: JSON.stringify(response.result),
                      csrfmiddlewaretoken: "{{csrf_token}}",
                    },
                    success: function(response) {

                      var element = document.createElement('a');
                      element.setAttribute('href', "data:application/pdf," + encodeURIComponent(response));
                      element.setAttribute('download', "reporteGenetico.pdf");

                      element.style.display = 'none';
                      document.body.appendChild(element);

                      element.click();

                      document.body.removeChild(element);
                    }
                  });
                }
              }
            },
            error: function (data) {
              document.getElementById("status").innerHTML = "Ha ocurrido un error!";
              console.error(data)
            }
          });
        };

        var refreshIntervalId = setInterval(function() {
          if(willstop == 0){
            poll();
          }else{
            clearInterval(refreshIntervalId);
          }
        },1000);
      })();
    </script>
  </body>
</html>
